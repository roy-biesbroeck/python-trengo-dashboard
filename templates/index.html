<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trengo Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg:       #f1f5f9;
      --card:     #ffffff;
      --border:   #e2e8f0;
      --text:     #1e293b;
      --muted:    #64748b;
      --blue:     #3b82f6;
      --green:    #16a34a;
      --amber:    #d97706;
      --red:      #dc2626;
      --shadow:   0 1px 3px rgba(0,0,0,.08), 0 1px 2px rgba(0,0,0,.05);
      --radius:   .75rem;

      /* Age colours: fresh â†’ stale */
      --age-0: #3b82f6;
      --age-1: #22c55e;
      --age-2: #84cc16;
      --age-3: #f59e0b;
      --age-4: #f97316;
      --age-5: #ef4444;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    html, body { height: 100%; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
                   'Helvetica Neue', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100dvh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      padding: 1rem 1.5rem .75rem;
      gap: .75rem;
    }

    /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }
    .header-left { display: flex; align-items: center; gap: .625rem; }
    .header-icon {
      width: 2rem; height: 2rem;
      background: var(--blue);
      border-radius: .5rem;
      display: flex; align-items: center; justify-content: center;
      font-size: 1rem;
    }
    .header h1 {
      font-size: clamp(1rem, 1.3vw, 1.25rem);
      font-weight: 700;
      letter-spacing: -.02em;
    }
    .header-right { display: flex; align-items: center; gap: .875rem; }
    .last-updated { font-size: .75rem; color: var(--muted); }

    .btn-refresh {
      display: flex; align-items: center; gap: .375rem;
      padding: .4rem .875rem;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: .5rem;
      font-size: .75rem;
      font-weight: 500;
      color: var(--text);
      cursor: pointer;
      box-shadow: var(--shadow);
      transition: background .15s, color .15s, border-color .15s;
    }
    .btn-refresh:hover    { background: var(--blue); color: #fff; border-color: var(--blue); }
    .btn-refresh:disabled { opacity: .5; cursor: not-allowed; }
    .btn-refresh.spinning svg { animation: spin .7s linear infinite; }

    /* â”€â”€ Summary strip â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: .75rem;
      flex-shrink: 0;
    }
    .summary-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: .875rem 1.25rem;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }
    .summary-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0;
      width: 4px; height: 100%;
    }
    .card-total::before   { background: var(--blue); }
    .card-new::before     { background: var(--green); }
    .card-assigned::before{ background: var(--amber); }

    .card-label {
      font-size: .625rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .06em;
      color: var(--muted);
      margin-bottom: .375rem;
    }
    .card-value {
      font-size: clamp(1.75rem, 2.5vw, 2.25rem);
      font-weight: 800;
      line-height: 1;
      letter-spacing: -.04em;
    }
    .card-total   .card-value { color: var(--blue);  }
    .card-new     .card-value { color: var(--green); }
    .card-assigned .card-value { color: var(--amber); }
    .card-sub { margin-top: .25rem; font-size: .75rem; color: var(--muted); }

    /* â”€â”€ Main three-column grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #main {
      flex: 1;
      min-height: 0;
      overflow: hidden;
    }
    .main-grid {
      display: grid;
      grid-template-columns: 1.2fr 1fr .85fr;
      gap: .875rem;
      height: 100%;
    }

    /* â”€â”€ Column â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .col {
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    .section-header {
      display: flex;
      align-items: baseline;
      gap: .4rem;
      flex-shrink: 0;
      margin-bottom: .5rem;
    }
    .section-title { font-size: .875rem; font-weight: 700; }
    .section-badge {
      font-size: .6875rem; font-weight: 600;
      color: var(--muted); background: var(--border);
      padding: .1rem .4rem; border-radius: 999px;
    }

    /* â”€â”€ Scrollable data card (teams / users) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .data-card {
      flex: 1;
      min-height: 0;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .data-head {
      flex-shrink: 0;
      background: #f8fafc;
      border-bottom: 1px solid var(--border);
      font-size: .625rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .06em;
      color: var(--muted);
    }
    .data-body {
      flex: 1;
      overflow-y: auto;
      min-height: 0;
    }
    /* custom scrollbar */
    .data-body::-webkit-scrollbar { width: 4px; }
    .data-body::-webkit-scrollbar-track { background: transparent; }
    .data-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 999px; }

    /* â”€â”€ Teams rows â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .data-head.t-head,
    .team-row {
      display: grid;
      grid-template-columns: 1fr 80px 80px 80px;
      align-items: center;
      padding: .5625rem 1.125rem;
      gap: .25rem;
    }
    .team-row {
      border-bottom: 1px solid var(--border);
      transition: background .1s;
    }
    .team-row:last-child { border-bottom: none; }
    .team-row:hover { background: #f8fafc; }

    .team-name-wrap { display: flex; align-items: center; gap: .5rem; }
    .dot {
      width: 7px; height: 7px;
      border-radius: 50%;
      background: var(--border);
      flex-shrink: 0;
    }
    .dot.has-new { background: var(--green); }
    .team-name { font-weight: 600; font-size: .875rem; }

    .col-r { text-align: right; }
    .num { font-size: 1rem; font-weight: 700; }
    .num.n-total    { color: var(--blue);  }
    .num.n-new      { color: var(--green); }
    .num.n-assigned { color: var(--amber); }

    .mini-bar {
      height: 3px;
      background: var(--border);
      border-radius: 999px;
      margin-top: .25rem;
      overflow: hidden;
    }
    .mini-fill { height: 100%; border-radius: 999px; background: var(--blue); }

    /* â”€â”€ User rows â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .data-head.u-head,
    .user-row {
      display: grid;
      grid-template-columns: 1fr 64px;
      align-items: center;
      padding: .5rem 1.125rem;
    }
    .user-row {
      border-bottom: 1px solid var(--border);
      transition: background .1s;
    }
    .user-row:last-child { border-bottom: none; }
    .user-row:hover { background: #f8fafc; }

    .user-name-wrap { display: flex; align-items: center; gap: .5rem; overflow: hidden; }
    .avatar {
      width: 26px; height: 26px;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: .5625rem; font-weight: 700;
      color: #fff; flex-shrink: 0;
      letter-spacing: .02em;
    }
    .user-name {
      font-weight: 600; font-size: .875rem;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }

    /* â”€â”€ Age card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .age-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .age-stacked {
      display: flex;
      height: 8px;
    }
    .age-stacked > div { transition: flex .5s ease; }

    .age-list {
      padding: .75rem 1.125rem;
      display: flex;
      flex-direction: column;
      gap: .5rem;
    }
    .age-item {
      display: flex;
      align-items: center;
      gap: .5rem;
    }
    .age-swatch {
      width: 9px; height: 9px;
      border-radius: 2px;
      flex-shrink: 0;
    }
    .age-name {
      flex: 1;
      font-size: .8rem;
      color: var(--text);
    }
    .age-sub {
      font-size: .6875rem;
      color: var(--muted);
      min-width: 52px;
    }
    .age-num {
      font-size: .9375rem;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
      min-width: 32px;
      text-align: right;
    }

    /* â”€â”€ Loading / Error â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .state-box {
      height: 100%;
      display: flex; align-items: center; justify-content: center;
      flex-direction: column; gap: .75rem;
      color: var(--muted); font-size: .9rem;
    }
    .spinner-ring {
      width: 32px; height: 32px;
      border: 3px solid var(--border);
      border-top-color: var(--blue);
      border-radius: 50%;
      animation: spin .7s linear infinite;
    }
    .error-box {
      background: #fef2f2; border: 1px solid #fecaca;
      color: var(--red); padding: 1rem 1.25rem;
      border-radius: var(--radius); font-size: .875rem;
    }
    .empty { padding: 1.5rem; color: var(--muted); text-align: center; font-size: .875rem; }

    /* â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .footer {
      flex-shrink: 0;
      font-size: .6875rem;
      color: var(--muted);
      text-align: center;
      line-height: 1;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* â”€â”€ Trend chart card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .trend-card {
      flex: 1;
      min-height: 0;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: .625rem .875rem .75rem;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .trend-chart-inner {
      position: relative;
      flex: 1;
      min-height: 0;
    }
    .trend-btn {
      padding: .15rem .5rem;
      border-radius: .3rem;
      font-size: .6875rem; font-weight: 600;
      background: none;
      border: 1px solid var(--border);
      color: var(--muted);
      cursor: pointer;
      transition: background .12s, color .12s, border-color .12s;
    }
    .trend-btn + .trend-btn { margin-left: .3rem; }
    .trend-btn:hover  { background: var(--bg); color: var(--text); }
    .trend-btn.active { background: var(--blue); color: #fff; border-color: var(--blue); }
    .trend-no-data {
      flex: 1;
      display: flex; align-items: center; justify-content: center;
      text-align: center;
      padding: .75rem;
      color: var(--muted); font-size: .75rem;
    }
  </style>
</head>
<body>

  <div class="header">
    <div class="header-left">
      <div class="header-icon">ðŸŽ«</div>
      <h1>Trengo Dashboard</h1>
    </div>
    <div class="header-right">
      <span class="last-updated" id="lastUpdated"></span>
      <button class="btn-refresh" id="refreshBtn" onclick="loadDashboard()">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none"
             stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="1 4 1 10 7 10"/><polyline points="23 20 23 14 17 14"/>
          <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10M23 14l-4.64 4.36A9 9 0 0 1 3.51 15"/>
        </svg>
        Vernieuwen
      </button>
    </div>
  </div>

  <div class="summary-grid" id="summary" style="display:none">
    <div class="summary-card card-total">
      <div class="card-label">Totaal open</div>
      <div class="card-value" id="s-total">â€“</div>
      <div class="card-sub">Actieve tickets</div>
    </div>
    <div class="summary-card card-new">
      <div class="card-label">Nieuw</div>
      <div class="card-value" id="s-new">â€“</div>
      <div class="card-sub">Niet toegewezen</div>
    </div>
    <div class="summary-card card-assigned">
      <div class="card-label">Toegewezen</div>
      <div class="card-value" id="s-assigned">â€“</div>
      <div class="card-sub">Gekoppeld aan persoon</div>
    </div>
  </div>

  <div id="main">
    <div class="state-box">
      <div class="spinner-ring"></div>
      <span>Dashboard ladenâ€¦</span>
    </div>
  </div>

  <div class="footer">
    Auto-refresh elke 5 minuten &nbsp;Â·&nbsp; OPEN = niet toegewezen &nbsp;Â·&nbsp; ASSIGNED = gekoppeld aan agent
  </div>

  <script>
    const AVATAR_COLORS = [
      '#3b82f6','#8b5cf6','#ec4899','#14b8a6',
      '#f59e0b','#10b981','#6366f1','#f97316',
    ];
    const AGE_COLORS = ['var(--age-0)','var(--age-1)','var(--age-2)',
                        'var(--age-3)','var(--age-4)','var(--age-5)'];

    function fmt(iso) {
      return new Date(iso).toLocaleTimeString('nl-NL', {
        hour: '2-digit', minute: '2-digit', second: '2-digit'
      });
    }
    function esc(s) {
      return String(s)
        .replace(/&/g,'&amp;').replace(/</g,'&lt;')
        .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }
    function initials(name) {
      const p = String(name).trim().split(/\s+/);
      return p.length >= 2 ? (p[0][0]+p[1][0]).toUpperCase() : String(name).slice(0,2).toUpperCase();
    }
    function avatarColor(name) {
      let h = 0;
      for (let i = 0; i < name.length; i++) h = name.charCodeAt(i) + ((h << 5) - h);
      return AVATAR_COLORS[Math.abs(h) % AVATAR_COLORS.length];
    }

    function renderTeams(teams) {
      if (!teams.length)
        return `<div class="empty">Geen teamdata beschikbaar</div>`;
      const max = Math.max(...teams.map(t => t.total), 1);
      return teams.map(t => {
        const pct = Math.round(t.total / max * 100);
        return `
          <div class="team-row">
            <div class="team-name-wrap">
              <div class="dot ${t.new > 0 ? 'has-new' : ''}"></div>
              <span class="team-name">${esc(t.name)}</span>
            </div>
            <div class="col-r">
              <div class="num n-total">${t.total}</div>
              <div class="mini-bar"><div class="mini-fill" style="width:${pct}%"></div></div>
            </div>
            <div class="col-r"><span class="num n-new">${t.new}</span></div>
            <div class="col-r"><span class="num n-assigned">${t.assigned}</span></div>
          </div>`;
      }).join('');
    }

    function renderUsers(users) {
      if (!users || !users.length)
        return `<div class="empty">Geen medewerkers met open tickets</div>`;
      const max = Math.max(...users.map(u => u.assigned), 1);
      return users.map(u => {
        const pct = Math.round(u.assigned / max * 100);
        const color = avatarColor(u.name);
        return `
          <div class="user-row">
            <div class="user-name-wrap">
              <div class="avatar" style="background:${color}">${esc(initials(u.name))}</div>
              <span class="user-name" title="${esc(u.name)}">${esc(u.name)}</span>
            </div>
            <div class="col-r">
              <span class="num n-assigned">${u.assigned}</span>
              <div class="mini-bar"><div class="mini-fill" style="width:${pct}%;background:var(--amber)"></div></div>
            </div>
          </div>`;
      }).join('');
    }

    function renderAge(buckets, total) {
      /* Stacked bar */
      const stackedSegs = buckets.map((b, i) =>
        `<div style="flex:${b.count || 0};background:${AGE_COLORS[i]}" title="${esc(b.label)}: ${b.count}"></div>`
      ).join('');
      const allZero = buckets.every(b => b.count === 0);
      const stackedBar = allZero
        ? `<div style="flex:1;background:var(--border)"></div>`
        : stackedSegs;

      /* List rows */
      const rows = buckets.map((b, i) => `
        <div class="age-item">
          <div class="age-swatch" style="background:${AGE_COLORS[i]}"></div>
          <span class="age-name">${esc(b.label)}</span>
          <span class="age-sub">${esc(b.sublabel)}</span>
          <span class="age-num" style="color:${AGE_COLORS[i]}">${b.count}</span>
        </div>`).join('');

      return `
        <div class="age-stacked">${stackedBar}</div>
        <div class="age-list">${rows}</div>`;
    }

    /* â”€â”€ Trend chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    let trendChart = null;
    let trendData  = [];
    let trendRange = 7;

    async function loadTrendChart() {
      try {
        const res = await fetch('/api/history');
        if (!res.ok) return;
        trendData = await res.json();
        renderTrendChart();
      } catch { /* silent */ }
    }

    function setTrendRange(days) {
      trendRange = days;
      document.querySelectorAll('.trend-btn').forEach(b => b.classList.remove('active'));
      const btn = document.getElementById(`trend-${days}d`);
      if (btn) btn.classList.add('active');
      renderTrendChart();
    }

    function renderTrendChart() {
      const cutoff   = new Date();
      cutoff.setDate(cutoff.getDate() - trendRange);
      const filtered = trendData.filter(d => new Date(d.ts) >= cutoff);

      const inner  = document.getElementById('trend-chart-inner');
      const noData = document.getElementById('trend-no-data');
      if (!inner) return;

      if (!filtered.length) {
        inner.style.display  = 'none';
        noData.style.display = '';
        if (trendChart) { trendChart.destroy(); trendChart = null; }
        return;
      }
      inner.style.display  = '';
      noData.style.display = 'none';

      const ptRadius = filtered.length > 60 ? 0 : 3;
      const labels   = filtered.map(d =>
        new Date(d.ts).toLocaleString('nl-NL', {
          month: 'short', day: 'numeric',
          hour: '2-digit', minute: '2-digit',
        })
      );
      const datasets = [
        {
          label: 'Totaal',
          data: filtered.map(d => d.total),
          borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,.08)',
          tension: .35, fill: true, pointRadius: ptRadius, borderWidth: 2,
        },
        {
          label: 'Nieuw',
          data: filtered.map(d => d.open),
          borderColor: '#16a34a', backgroundColor: 'transparent',
          tension: .35, fill: false, pointRadius: ptRadius, borderWidth: 2,
        },
        {
          label: 'Toegewezen',
          data: filtered.map(d => d.assigned),
          borderColor: '#d97706', backgroundColor: 'transparent',
          tension: .35, fill: false, pointRadius: ptRadius, borderWidth: 2,
        },
      ];

      if (trendChart) { trendChart.destroy(); trendChart = null; }

      const canvas = document.getElementById('trend-canvas');
      if (!canvas) return;

      trendChart = new Chart(canvas, {
        type: 'line',
        data: { labels, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: {
              position: 'top',
              labels: { font: { size: 10 }, boxWidth: 8, padding: 10 },
            },
          },
          scales: {
            x: {
              ticks: {
                font: { size: 9 }, maxRotation: 30,
                autoSkip: true, maxTicksLimit: 8,
              },
              grid: { display: false },
            },
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1, font: { size: 9 },
                callback: v => Number.isInteger(v) ? v : null,
              },
              grid: { color: 'rgba(0,0,0,.04)' },
            },
          },
        },
      });
    }

    /* â”€â”€ Main render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function render(data) {
      const { summary, teams, users, age_buckets, last_updated } = data;

      document.getElementById('lastUpdated').textContent = `Bijgewerkt om ${fmt(last_updated)}`;

      /* Summary strip */
      document.getElementById('s-total').textContent    = summary.total;
      document.getElementById('s-new').textContent      = summary.new;
      document.getElementById('s-assigned').textContent = summary.assigned;
      document.getElementById('summary').style.display  = '';

      /* Destroy old chart before rebuilding DOM */
      if (trendChart) { trendChart.destroy(); trendChart = null; }

      /* Main grid */
      document.getElementById('main').innerHTML = `
        <div class="main-grid">

          <!-- Per team -->
          <div class="col">
            <div class="section-header">
              <span class="section-title">Per team</span>
              <span class="section-badge">${teams.length} team${teams.length !== 1 ? 's' : ''}</span>
            </div>
            <div class="data-card">
              <div class="data-head t-head">
                <div>Team</div>
                <div class="col-r">Totaal</div>
                <div class="col-r">Nieuw</div>
                <div class="col-r">Toegewezen</div>
              </div>
              <div class="data-body">${renderTeams(teams)}</div>
            </div>
          </div>

          <!-- Per medewerker -->
          <div class="col">
            <div class="section-header">
              <span class="section-title">Per medewerker</span>
              <span class="section-badge">${users ? users.length : 0} agent${!users || users.length !== 1 ? 's' : ''}</span>
            </div>
            <div class="data-card">
              <div class="data-head u-head">
                <div>Medewerker</div>
                <div class="col-r">Toegewezen</div>
              </div>
              <div class="data-body">${renderUsers(users)}</div>
            </div>
          </div>

          <!-- Ticket ouderdom + Trend -->
          <div class="col">
            <div class="section-header">
              <span class="section-title">Ticket ouderdom</span>
              <span class="section-badge">${summary.total} tickets</span>
            </div>
            <div class="age-card">
              ${age_buckets ? renderAge(age_buckets, summary.total) : '<div class="empty">Geen data</div>'}
            </div>

            <div class="section-header" style="margin-top:.625rem">
              <span class="section-title">Ticket trend</span>
              <div>
                <button class="trend-btn active" id="trend-7d"  onclick="setTrendRange(7)">7d</button>
                <button class="trend-btn"         id="trend-30d" onclick="setTrendRange(30)">30d</button>
              </div>
            </div>
            <div class="trend-card">
              <div class="trend-chart-inner" id="trend-chart-inner">
                <canvas id="trend-canvas"></canvas>
              </div>
              <div class="trend-no-data" id="trend-no-data" style="display:none">
                Nog geen historische data.<br>Wordt opgeslagen bij elke refresh.
              </div>
            </div>
          </div>

        </div>`;

      loadTrendChart();
    }

    async function loadDashboard() {
      const btn = document.getElementById('refreshBtn');
      btn.disabled = true;
      btn.classList.add('spinning');

      try {
        const res  = await fetch('/api/dashboard');
        const data = await res.json();
        if (!res.ok || data.error) throw new Error(data.error || `HTTP ${res.status}`);
        render(data);
      } catch (err) {
        document.getElementById('main').innerHTML = `
          <div class="state-box">
            <div class="error-box"><strong>Fout bij laden:</strong> ${esc(err.message)}</div>
          </div>`;
        document.getElementById('lastUpdated').textContent = '';
      } finally {
        btn.disabled = false;
        btn.classList.remove('spinning');
      }
    }

    loadDashboard();
    setInterval(loadDashboard, 5 * 60 * 1000);
  </script>
</body>
</html>
